<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="description" content="Tonemapping GLSL shader sandbox">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>TonemapToy</title>
    <style>
        html,
        body {
            margin: 0;
            height: 100%;
        }

        body {
            font-family: Consolas, monospace;
            color: #ccc;
            background: #111;
            display: flex;
            flex-direction: column;
        }

        input,
        select,
        textarea {
            color: white !important;
            background: #333 !important;
        }

        input[type="number"] {
            width: 7rem;
        }

        header {
            text-align: center;
            padding: 1rem 0;
        }

        h1 {
            display: inline;
            font-family: Arial, Helvetica, sans-serif;
            margin: 0;
            background: radial-gradient(#ffffff, #e19e77 30%, #235e7d 80%);
            background-clip: text;
            color: transparent;
            font-weight: bolder;
            letter-spacing: 0.2rem;
            text-align: center;
        }

        #layout {
            flex: 1;
            display: flex;
            min-height: 0;
        }

        #controls {
            flex: 0 0 auto;
            overflow-y: auto;
            overflow-x: hidden;
            padding-left: 1rem;

            >*,
            div {
                display: block;
                margin: 0 0 10px;
            }

            label,
            input {
                display: block;
            }

            input[type="checkbox"],
            input[type="checkbox"]+label {
                display: inline;
                vertical-align: middle;
            }

            textarea {
                white-space: pre;
            }
        }

        #canvas-holder {
            flex: 1;
            display: flex;
            justify-content: center;
            align-items: center;
            padding: 20px;
        }

        canvas {
            max-width: 100%;
            max-height: 100%;
            /*width: auto;
            height: auto;
            object-fit: contain;*/
        }
    </style>
    <script type="importmap">
    {
        "imports": {
            "three": "https://cdn.jsdelivr.net/npm/three@0.179.1/build/three.module.js",
            "three/addons/": "https://cdn.jsdelivr.net/npm/three@0.179.1/examples/jsm/"
        }
    }
    </script>
    <script type="module" src="main.js"></script>
</head>

<body>
    <header>
        <h1>TonemapToy</h1>
    </header>
    <div id="layout">
        <div id="controls">
            <div>
                <label for="image-select">Sample image</label>
                <select id="image-select"></select>
            </div>
            <div>
                <label for="file-input">EXR image file</label>
                <input type="file" id="file-input" />
            </div>
            <div>
                <label for="exposure-input">Exposure</label>
                <input id="exposure-input" type="range" min="-10" max="15" step="0.1" value="0" />
            </div>
            <div>
                <input id="show-clamp-input" type="checkbox" /><label for="show-clamp-input">Mark clamped areas</label>
            </div>
            <div>
                <input id="srgb-display-gamma-input" type="checkbox" checked /><label
                    for="srgb-display-gamma-input">Encode in gamma 2.2</label>
            </div>

            <label for="preset-select">Shader preset</label>
            <select id="preset-select"></select>
            <label for="user-shader">GLSL</label>
            <textarea id="user-shader" name="user-shader" rows="15" cols="72"></textarea>

            <button id="compile-shader">Compile</button>
            <div id="uniform-controls"></div>
        </div>
        <div id="canvas-holder"><canvas></canvas></div>
    </div>

    <script id="vs" type="x-shader/vertex">
#version 300 es
in vec2 _pos;
out vec2 _uv;
uniform float _viewAspectRatio;
uniform float _imageAspectRatio;

void main() {
    _uv = _pos;
    vec2 aspectCorrectPos = 2.0 * vec2(_imageAspectRatio / _viewAspectRatio * (_pos.x-0.5), (_pos.y-0.5));
    gl_Position = vec4(aspectCorrectPos, 0, 1);
}
    </script>
    <script id="fs" type="x-shader/fragment">
#version 300 es
precision mediump float;

in vec2 _uv;
out vec4 _outputColor;
uniform sampler2D _tex;
uniform float _exposure;
uniform bool _showClamp;
uniform bool _pureGammaEncode;

// GENERATED MACROS GO HERE

// YOUR CODE GOES HERE

vec3 _sRgbIeotf(vec3 x) {
    // See https://community.acescentral.com/t/srgb-piece-wise-eotf-vs-pure-gamma/4024
    if (_pureGammaEncode) {
        return pow(x, vec3(1.0 / 2.2));
    }
    return mix(
        1.055 * pow(x, vec3(1.0 / 2.4)) - 0.055,
        12.92 * x,
        vec3(lessThan(x, vec3(0.0031308)))
    );
}

void main() {
    vec3 x = texture(_tex, _uv).rgb;
    x = max(x, 0.0); 

    vec3 tonemapped = tonemap(_exposure * x);

    if (_showClamp) {
        if (
            min(tonemapped.r, min(tonemapped.g, tonemapped.b)) < -0.0001
            || max(tonemapped.r, max(tonemapped.g, tonemapped.b)) > 1.0001
        ) tonemapped = vec3(1.0, 0.0, 1.0);
    }
    _outputColor = vec4(_sRgbIeotf(clamp(tonemapped, 0.0, 1.0)), 1.0);
}
    </script>
</body>

</html>